<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"
        charset="utf-8"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.icon.glyph@0.3.0/Leaflet.Icon.Glyph.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet"
        type="text/css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        #right-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            width: 8em;
            display: flex;
            flex-direction: column;
            gap: 1em;
        }

        #right-menu>form {
            background-color: white;
            border: 1px solid #6c757d;
            border-radius: 0.25rem;
            padding: 0.5em;
        }

        #right-menu>form label {
            font-size: 0.8em;
        }

        #prefecture-select>div {
            height: 8em;
            overflow-y: auto;
        }

        div[class*=glyph]>.mdi {
            font-size: 1em !important;
        }

        div.marker-color-red {
            filter: hue-rotate(120deg);
        }

        div.marker-color-green {
            filter: hue-rotate(240deg);
        }

        div.marker-color-gold {
            filter: hue-rotate(171deg);
        }

        .leaflet-control-attribution {
            max-width: 50vw;
        }
    </style>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <div id="right-menu">
        <form id="prefecture-select">
            <small>Prefecture</small>
            <div>
                <label>
                    <input type="checkbox" name="prefecture" value="0">
                    北海道
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="1">
                    青森県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="2">
                    岩手県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="3">
                    宮城県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="4">
                    秋田県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="5">
                    山形県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="6">
                    福島県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="7">
                    茨城県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="8">
                    栃木県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="9">
                    群馬県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="10">
                    埼玉県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="11">
                    千葉県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="12">
                    東京都
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="13">
                    神奈川県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="14">
                    新潟県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="15">
                    富山県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="16">
                    石川県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="17">
                    福井県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="18">
                    山梨県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="19">
                    長野県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="20">
                    岐阜県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="21">
                    静岡県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="22">
                    愛知県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="23">
                    三重県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="24">
                    滋賀県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="25">
                    京都府
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="26">
                    大阪府
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="27">
                    兵庫県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="28">
                    奈良県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="29">
                    和歌山県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="30">
                    鳥取県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="31">
                    島根県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="32">
                    岡山県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="33">
                    広島県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="34">
                    山口県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="35">
                    徳島県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="36">
                    香川県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="37">
                    愛媛県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="38">
                    高知県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="39">
                    福岡県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="40">
                    佐賀県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="41">
                    長崎県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="42">
                    熊本県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="43">
                    大分県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="44">
                    宮崎県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="45">
                    鹿児島県
                </label>
                <label>
                    <input type="checkbox" name="prefecture" value="46">
                    沖縄県
                </label>
            </div>
        </form>
        <form id="game-select">
            <small>Must have...</small>
            <label>
                <input type="checkbox" name="game" value="88">
                Ongeki
            </label>
            <label>
                <input type="checkbox" name="game" value="96">
                Maimai
            </label>
            <label>
                <input type="checkbox" name="game" value="109">
                Chunithm
            </label>
        </form>
    </div>

    <div id="map"></div>

    <template id="popup">
        <div>
            <b class="store-name"></b>
            <br>
            <a href="" target="_blank">
                <img src='https://upload.wikimedia.org/wikipedia/commons/3/39/Google_Maps_icon_%282015-2020%29.svg'
                    width='16' height='16'>
                <span class="address"></span>
            </a>
            <br>
            <table class="table table-sm">
                <tbody></tbody>
            </table>

            <div class="btn-group btn-group-sm" role="group"></div>
        </div>
    </template>

    <script>
        const restore = (name, defaultValue) => {
            try {
                return localStorage.getItem(name).toString();
            } catch (error) {
                localStorage.removeItem(name);
                return defaultValue;
            }
        };

        const restoreObject = (name, defaultValue) => {
            const value = restore(name, null);
            if (value === null) {
                return defaultValue;
            }

            return JSON.parse(value);
        };

        const gameNames = {
            88: "Ongeki",
            96: "Maimai",
            109: "Chunithm"
        };

        // Map of storeId -> favoriteType
        const favorites = restoreObject("favorites", {});
        const center = restoreObject("center", {
            lat: 36.01,
            lng: 138,
            zoom: 5
        });
        let mapStyle = restore("map-style", "Original");

        document.addEventListener("DOMContentLoaded", async () => {
            let games = {};
            let stores = {};

            const map = L.map("map").setView(center, center.zoom);

            map.on("moveend", () => {
                autoSave();
            });

            const baseLayers = {
                "Original": L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                        maxZoom: 19,
                        attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
                    }
                ),
                "Cycle": L.tileLayer(
                    "https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}@2x.png?apikey=6e5478c8a4f54c779f85573c0e399391",
                    {
                        maxZoom: 19,
                        attribution: '© <a href="/copyright">OpenStreetMap contributors</a>. Tiles courtesy of <a href="https://www.thunderforest.com/" target="_blank">Andy Allan</a>. <a href="https://wiki.osmfoundation.org/wiki/Terms_of_Use">Website and API terms</a>'
                    }
                ),
                "Transport": L.tileLayer(
                    "https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}@2x.png?apikey=6e5478c8a4f54c779f85573c0e399391",
                    {
                        maxZoom: 19,
                        attribution: '© <a href="/copyright">OpenStreetMap contributors</a>. Tiles courtesy of <a href="https://www.thunderforest.com/" target="_blank">Andy Allan</a>. <a href="https://wiki.osmfoundation.org/wiki/Terms_of_Use">Website and API terms</a>'
                    }
                ),
                "Google Map": L.tileLayer(
                    "http://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=en",
                    {
                        maxZoom: 19,
                        attribution: '© Google'
                    }
                )
            };

            const layer = L.markerClusterGroup();

            L.control.layers(baseLayers, null, { position: "bottomleft" }).addTo(map);
            baseLayers[mapStyle].addTo(map);

            map.on('baselayerchange', (e) => {
                const url = e.layer._url;
                const style = Object.keys(baseLayers).find(key => baseLayers[key]._url === url);
                mapStyle = style;
                autoSave();
            });

            L.control.locate({
                locateOptions: {
                    enableHighAccuracy: true
                }
            }).addTo(map);

            // 4 color theorem
            const prefectureColors =
                [1, 0, 1, 2, 3, 0, 1, 0, 2, 3, 1, 3, 2, 1, 2, 3, 1, 0, 3, 0, 2, 2, 3, 0, 1, 3, 0, 1, 2, 1, 2, 3, 0, 1, 0, 3, 2, 0, 1, 1, 0, 2, 3, 2, 1, 0, 2]
                    .map(color => [
                        "red",
                        "green",
                        "blue",
                        "gold"
                    ][color]);

            try {
                const [storesResponse, gamesResponse] = await Promise.all([
                    fetch("stores.json"),
                    fetch("games.json")
                ]);
                stores = await storesResponse.json();
                games = await gamesResponse.json();
            } catch (error) {
                console.error("Error loading data:", error);
            }

            const getIcon = (storeId) => {
                const store = stores[storeId];
                const favoriteType = favorites[storeId];

                return new L.Icon.Glyph(favoriteType ? {
                    prefix: "mdi",
                    glyph: favoriteType,
                    className: `marker-color-${prefectureColors[store.prefecture]} glyph-${favoriteType}`
                } : {
                    prefix: "",
                    glyph: " ",
                    className: `marker-color-${prefectureColors[store.prefecture]}`
                })
            };

            const createMarker = (storeId) => {
                const store = stores[storeId];
                const favoriteType = favorites[storeId];

                const marker = L.marker([store.lat, store.lon], {
                    icon: getIcon(storeId)
                });

                const popupClone = document.getElementById("popup").content.cloneNode(true).firstElementChild;
                popupClone.querySelector(".store-name").textContent = store.name;
                popupClone.querySelector("a").href = `https://maps.google.com/maps/search/${encodeURIComponent(store.name)}/@${store.lat},${store.lon},16z`;
                popupClone.querySelector(".address").textContent = store.address;
                popupClone.querySelector("table tbody").innerHTML = Object.keys(games).map(gameId => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${gameNames[gameId]}</td>
                        <td>${games[gameId].includes(+storeId) ? "✅" : "❌"}</td>
                    `;
                    return tr.outerHTML;
                }).join("");

                const favoriteButtons = popupClone.querySelector(".btn-group");
                for (const type of [
                    "heart",
                    "star",
                    "alert",
                    "check-bold",
                    "close-thick",
                    "help-circle"
                ]) {
                    const button = document.createElement("button");
                    button.type = "button";
                    button.classList.add("btn", "text-light", `btn-${favoriteType === type ? "success" : "secondary"}`);
                    button.addEventListener("click", () => {
                        if (button.classList.contains("btn-success")) {
                            delete favorites[storeId];
                        } else {
                            favorites[storeId] = type;
                        }
                        autoSave();

                        for (const _button of [...favoriteButtons.querySelectorAll("button")]) {
                            if (favorites[storeId]) {
                                _button.classList.toggle("btn-success", _button === button);
                                _button.classList.toggle("btn-secondary", _button !== button);
                            } else {
                                _button.classList.replace("btn-success", "btn-secondary");
                            }
                        }

                        marker.setIcon(getIcon(storeId));
                    });
                    button.innerHTML = `<i class="mdi mdi-${type}"></i>`;
                    favoriteButtons.appendChild(button);
                }

                marker.bindPopup(popupClone);
                return marker;
            };

            const markers = {};
            for (const storeId of Object.keys(stores)) {
                markers[storeId] = createMarker(storeId);
            }

            const autoSave = () => {
                localStorage.setItem("required-game", JSON.stringify(requiredGame));
                localStorage.setItem("favorites", JSON.stringify(favorites));
                localStorage.setItem("center", JSON.stringify({
                    ...map.getCenter(),
                    zoom: map.getZoom()
                }));
                localStorage.setItem("map-style", mapStyle);
                localStorage.setItem("included-prefectures", JSON.stringify(includedPrefectures));
            };

            const redraw = () => {
                const formData = new FormData(gameSelectForm);
                const selectedGames = formData.getAll("game");
                const selectedStores = Object.keys(stores).filter(storeId => {
                    return selectedGames.every(gameId => games[gameId].includes(+storeId));
                });

                for (const storeId of Object.keys(markers)) {
                    if (selectedStores.includes(storeId)) {
                        layer.addLayer(markers[storeId]);
                    } else {
                        layer.removeLayer(markers[storeId]);
                    }
                }
            };

            // Prefecture select
            const includedPrefectures = restoreObject("included-prefectures", Array.from({ length: 47 }, (_, i) => i));
            const prefectureSelectForm = document.getElementById("prefecture-select");

            for (const checkbox of prefectureSelectForm.querySelectorAll("input")) {
                checkbox.addEventListener("change", () => {
                    if (checkbox.checked) {
                        includedPrefectures.push(+checkbox.value);
                    } else {
                        includedPrefectures.splice(includedPrefectures.indexOf(+checkbox.value), 1);
                    }
                    includedPrefectures.sort((a, b) => a - b);
                    autoSave();

                    for (const storeId of Object.keys(stores)) {
                        if (includedPrefectures.includes(stores[storeId].prefecture)) {
                            layer.addLayer(markers[storeId]);
                        } else {
                            layer.removeLayer(markers[storeId]);
                        }
                    }
                });
            }

            for (const checkbox of prefectureSelectForm.querySelectorAll("input")) {
                checkbox.checked = includedPrefectures.includes(+checkbox.value);
            }

            // Game select
            const requiredGame = restoreObject("required-game", {
                88: false,
                96: false,
                109: false
            });

            const gameSelectForm = document.getElementById("game-select");
            for (const checkbox of gameSelectForm.querySelectorAll("input")) {
                checkbox.addEventListener("change", () => {
                    requiredGame[checkbox.value] = checkbox.checked;
                    autoSave();

                    redraw();
                });
            }

            for (const [gameId, required] of Object.entries(requiredGame)) {
                const checkbox = gameSelectForm.querySelector(`input[value="${gameId}"]`);
                if (checkbox) {
                    checkbox.checked = required;
                }
            }
            
            redraw();
            map.addLayer(layer);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>