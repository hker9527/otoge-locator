<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"
        charset="utf-8"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        #gameSelect {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            width: 8em;

        div[class*=glyph]>.mdi {
            font-size: 1em !important;
        }

        div.marker-color-red {
            filter: hue-rotate(120deg);
        }

        div.marker-color-green {
            filter: hue-rotate(240deg);
        }

        div.marker-color-gold {
            filter: hue-rotate(171deg);
        }
    </style>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <form id="gameSelect" class="bg-white border border-secondary rounded p-2">
        <label>
            <input type="checkbox" name="game" value="88">
            Ongeki
        </label>
        <label>
            <input type="checkbox" name="game" value="96">
            Maimai
        </label>
        <label>
            <input type="checkbox" name="game" value="109">
            Chunithm
        </label>
    </form>

    <div id="map"></div>

    <template id="popup">
        <div>
            <b class="store-name"></b>
            <br>
            <a href="" target="_blank">
                <img src='https://upload.wikimedia.org/wikipedia/commons/3/39/Google_Maps_icon_%282015-2020%29.svg'
                    width='16' height='16'>
                <span class="address"></span>
            </a>
            <br>
            <table class="table table-sm">
                <tbody></tbody>
            </table>

            <div class="btn-group btn-group-sm" role="group"></div>
        </div>
    </template>

    <script>
            const gameNames = {
                88: "Ongeki",
                96: "Maimai",
                109: "Chunithm"
            };

        // Map of storeId -> favoriteType
        const favorites = (() => {
            try {
                return JSON.parse(localStorage.getItem("favorites")) || {};
            } catch (error) {
                localStorage.removeItem("favorites");
                return {};
            }
        })();

        document.addEventListener("DOMContentLoaded", async () => {
            let games = {};
            let stores = {};

            const map = L.map("map").setView([36, 138], 6);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
            }).addTo(map);

            L.control.locate({
                locateOptions: {
                    enableHighAccuracy: true
                }
            }).addTo(map);

            // 4 color theorem
            const prefectureColors =
                [1, 0, 1, 2, 3, 0, 1, 0, 2, 3, 1, 3, 2, 1, 2, 3, 1, 0, 3, 0, 2, 2, 3, 0, 1, 3, 0, 1, 2, 1, 2, 3, 0, 1, 0, 3, 2, 0, 1, 1, 0, 2, 3, 2, 1, 0, 2]
                    .map(color => [
                "red",
                "green",
                "blue",
                "gold"
                    ][color]);

            try {
                const [storesResponse, gamesResponse] = await Promise.all([
                    fetch("stores.json"),
                    fetch("games.json")
                ]);
                stores = await storesResponse.json();
                games = await gamesResponse.json();
            } catch (error) {
                console.error("Error loading data:", error);
            }

            const layer = L.markerClusterGroup();

            const getIcon = (storeId) => {
                const store = stores[storeId];
                const favoriteType = favorites[storeId];

                return new L.Icon.Glyph(favoriteType ? {
                    prefix: "mdi",
                    glyph: favoriteType,
                    className: `marker-color-${prefectureColors[store.prefecture]} glyph-${favoriteType}`
                } : {
                    prefix: "",
                    glyph: " ",
                    className: `marker-color-${prefectureColors[store.prefecture]}`
                })
            };

            const createMarker = (storeId) => {
                const store = stores[storeId];
                const favoriteType = favorites[storeId];

                const marker = L.marker([store.lat, store.lon], {
                    icon: getIcon(storeId)
                });

                const popupClone = document.getElementById("popup").content.cloneNode(true).firstElementChild;
                popupClone.querySelector(".store-name").textContent = store.name;
                popupClone.querySelector("a").href = `https://maps.google.com/maps/search/${encodeURIComponent(store.name)}/@${store.lat},${store.lon},16z`;
                popupClone.querySelector(".address").textContent = store.address;
                popupClone.querySelector("table tbody").innerHTML = Object.keys(games).map(gameId => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${gameNames[gameId]}</td>
                        <td>${games[gameId].includes(+storeId) ? "✅" : "❌"}</td>
                    `;
                    return tr.outerHTML;
                }).join("");

                const favoriteButtons = popupClone.querySelector(".btn-group");
                for (const type of [
                    "heart",
                    "star",
                    "alert",
                    "check-bold",
                    "close-thick",
                    "help-circle"
                ]) {
                    const button = document.createElement("button");
                    button.type = "button";
                    button.classList.add("btn", "text-light", `btn-${favoriteType === type ? "success" : "secondary"}`);
                    button.addEventListener("click", () => {
                        if (button.classList.contains("btn-success")) {
                            delete favorites[storeId];
                        } else {
                            favorites[storeId] = type;
                        }
                        autoSave();

                        for (const _button of [...favoriteButtons.querySelectorAll("button")]) {
                            if (favorites[storeId]) {
                                _button.classList.toggle("btn-success", _button === button);
                                _button.classList.toggle("btn-secondary", _button !== button);
                            } else {
                                _button.classList.replace("btn-success", "btn-secondary");
                            }
                        }

                        marker.setIcon(getIcon(storeId));
                    });
                    button.innerHTML = `<i class="mdi mdi-${type}"></i>`;
                    favoriteButtons.appendChild(button);
                }

                marker.bindPopup(popupClone);
                return marker;
            };

            const addMarkers = (storeIds) => {
                for (const storeId of storeIds) {
                    const marker = createMarker(storeId);
                    layer.addLayer(marker);
                }

                map.addLayer(layer);
            };

            const checked = {
                88: false,
                96: false,
                109: false
            }

            const autoSave = () => {
                localStorage.setItem("checked", JSON.stringify(checked));
                localStorage.setItem("favorites", JSON.stringify(favorites));
            };

            const redraw = () => {
                    const formData = new FormData(gameSelectForm);
                    const selectedGames = formData.getAll("game");
                    const selectedStores = Object.keys(stores).filter(storeId => {
                        return selectedGames.every(gameId => games[gameId].includes(+storeId));
                    });

                layer.clearLayers();
                    addMarkers(selectedStores);

                    checked[checkbox.value] = checkbox.checked;
                    autoSave();
            };

            const gameSelectForm = document.getElementById("game-select");
            for (const checkbox of gameSelectForm.querySelectorAll("input")) {
                checkbox.addEventListener("change", redraw);
            }

            try {
                const saved = JSON.parse(localStorage.getItem("checked"));
                    for (const [gameId, checked] of Object.entries(saved)) {
                        const checkbox = gameSelectForm.querySelector(`input[value="${gameId}"]`);
                        if (checkbox) {
                            checkbox.checked = checked;
                    }
                }

            } catch (error) {
                localStorage.removeItem("checked");
            } finally {
                redraw();
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>